# The udpIpPg Ethernet UDP/IPV4 Driver VIP

The ethernet driving BFM is based around the open-source the UDP/IPv4 packet generator ([_udpPgIp_](https://github.com/wyvernSemi/udpIpPg)) model. This, like [`soc_cpu.VPROC`](../README.md#soc_cpuvproc) is also constructed around _VProc_, with the packet generation being done within a C++ program running on VProc. To drive the actual GMII signalling, the ports are memory mapped into _VProc_ space, and ports set/read in delta-time, advancing a tick at the end of this process. Since the _udpIpPg_ program is running on _VProc_, the software has access to the [_mem_model_](https://github.com/wyvernSemi/mem_model) address space and can access data between itself and the `soc_cpu.VPROC` module, closing the verification end-to-end loop on data generation and reception. 

<p align="center"><img width=500 src="https://github.com/user-attachments/assets/c83493e5-3c3e-41c9-a561-74a459a2fa96"></p>

The _udpIpPg_ HDL component consists of a clock (`clk`), GMII transmit and receive signals (`txd`, `txen`, `txer`, `rxd`, `rxdv` and `rxer`) and a `halt` output. It has a single `NODE` parameter to define the node number of its internal _VProc_ component. The diagram below shows a single _udpIpPg_ component (of four) and how its is used within the `bfm_ethernet` block.

<p align="center"><img width=750 src="https://github.com/user-attachments/assets/924f547d-91aa-46e6-ae94-8a837fb03ef8"></p>

Internal logic maps the GMII port signals to _VProc_'s generic bus to be driven by the `udpIpPg` software provided with the model. This interfaces between the _VProc_'s API and provideda UDP packet API  to the user test program. Like the programs run on `soc_cpu.VProc`, the entry point for the _VProc_ node is `VUserMain<n>` where `<n>` is the _udpIpPg_ node number (1 to 4 for Wireguard FPGA's test bench). RGMII output can be generated by converting GMII to RGMII using the supplied `gmii_rgmii_conv.v` module. Within `bfm_ethernet` block that instantionas the _udpIpPg_ models, a [parameter](../README.md#the-bfm_ethernet-ethernet-driver-module) can select between GMII and RGMII.

The `halt` output is an optionally used signal that can be set from _updIpPg_ [software](../../README.md#udpippg-software), via the API, to indicate that the program is finished and halted. This might be used in the test bench to indicate that the simulation can finish when all drivers have finished.
